@model mostlylucid.pagingtaghelper.Models.TagModels.ContinuationPagerViewModel
@using mostlylucid.pagingtaghelper.Models
@{
    var jsMode = Model.EffectiveJSMode;
    var linkUrl = Model.LinkUrl;
    var currentPage = Model.CurrentPage;
    var pageSize = Model.PageSize;
    var searchTerm = Model.SearchTerm;
    var nextToken = Model.NextPageToken;
    var canGoBack = Model.CanNavigatePrevious;
    var canGoNext = Model.CanNavigateNext;
    var previousToken = Model.GetPreviousPageToken();

    // Serialize token history for passing to next page
    var tokenHistoryJson = Model.PageTokenHistory != null
        ? System.Text.Json.JsonSerializer.Serialize(Model.PageTokenHistory)
        : "{}";

    // Build query strings - preserves all current query parameters except our own
    string BuildQueryString(string? token, int page)
    {
        var query = new Dictionary<string, string>();

        // First, preserve all existing query parameters except continuation pager's own
        var excludeParams = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "pageSize", "currentPage", "pageToken", "tokenHistory"
        };

        foreach (var param in ViewContext.HttpContext.Request.Query)
        {
            if (!excludeParams.Contains(param.Key))
            {
                query[param.Key] = param.Value.ToString();
            }
        }

        // Then add/override with continuation pager parameters
        query["pageSize"] = pageSize.ToString();
        query["currentPage"] = page.ToString();

        if (!string.IsNullOrEmpty(token))
            query["pageToken"] = token;

        if (Model.EnableTokenAccumulation)
            query["tokenHistory"] = tokenHistoryJson;

        return string.Join("&", query.Select(kvp => $"{Uri.EscapeDataString(kvp.Key)}={Uri.EscapeDataString(kvp.Value)}"));
    }

    var prevUrl = canGoBack ? $"{linkUrl}?{BuildQueryString(previousToken, currentPage - 1)}" : "#";
    var nextUrl = canGoNext ? $"{linkUrl}?{BuildQueryString(nextToken, currentPage + 1)}" : "#";

    // HTMX attributes
    var hxTarget = !string.IsNullOrEmpty(Model.HtmxTarget) ? Model.HtmxTarget : null;
    var swapValue = "outerHTML";
}

<div class="flex gap-2 items-center @Model.CssClass" id="@Model.PagerId">
    @* Previous Button *@
    @if (jsMode == JavaScriptMode.HTMX && !string.IsNullOrEmpty(hxTarget))
    {
        <button
            class="px-4 py-2 text-sm font-medium rounded-md @(canGoBack ? "bg-blue-600 text-white hover:bg-blue-700" : "bg-gray-200 text-gray-400 cursor-not-allowed")"
            hx-get="@prevUrl"
            hx-target="@hxTarget"
            hx-swap="@swapValue"
            aria-label="@Model.PreviousPageAriaLabel"
            disabled="@(!canGoBack)">
            @Model.PreviousPageText
        </button>
    }
    else if (jsMode == JavaScriptMode.HTMXWithAlpine && !string.IsNullOrEmpty(hxTarget))
    {
        <button
            class="px-4 py-2 text-sm font-medium rounded-md @(canGoBack ? "bg-blue-600 text-white hover:bg-blue-700" : "bg-gray-200 text-gray-400 cursor-not-allowed")"
            x-data
            hx-get="@prevUrl"
            hx-target="@hxTarget"
            hx-swap="@swapValue"
            aria-label="@Model.PreviousPageAriaLabel"
            disabled="@(!canGoBack)">
            @Model.PreviousPageText
        </button>
    }
    else if (jsMode == JavaScriptMode.Alpine)
    {
        <button
            class="px-4 py-2 text-sm font-medium rounded-md @(canGoBack ? "bg-blue-600 text-white hover:bg-blue-700" : "bg-gray-200 text-gray-400 cursor-not-allowed")"
            x-data
            @@click="window.location.href = '@prevUrl'"
            aria-label="@Model.PreviousPageAriaLabel"
            disabled="@(!canGoBack)">
            @Model.PreviousPageText
        </button>
    }
    else if (jsMode == JavaScriptMode.PlainJS)
    {
        <button
            class="px-4 py-2 text-sm font-medium rounded-md @(canGoBack ? "bg-blue-600 text-white hover:bg-blue-700" : "bg-gray-200 text-gray-400 cursor-not-allowed")"
            onclick="window.location.href = '@prevUrl'"
            aria-label="@Model.PreviousPageAriaLabel"
            disabled="@(!canGoBack)">
            @Model.PreviousPageText
        </button>
    }
    else
    {
        @if (canGoBack)
        {
            <a href="@prevUrl"
               class="px-4 py-2 text-sm font-medium rounded-md bg-blue-600 text-white hover:bg-blue-700"
               aria-label="@Model.PreviousPageAriaLabel">
                @Model.PreviousPageText
            </a>
        }
        else
        {
            <span class="px-4 py-2 text-sm font-medium rounded-md bg-gray-200 text-gray-400 cursor-not-allowed">@Model.PreviousPageText</span>
        }
    }

    @* Current Page Indicator *@
    @if (Model.ShowPageNumber)
    {
        <div class="px-3 py-1 text-sm font-medium bg-gray-100 dark:bg-gray-700 dark:text-white rounded-md">
            <text>Page </text>@currentPage
        </div>
    }

    @* Next Button *@
    @if (jsMode == JavaScriptMode.HTMX && !string.IsNullOrEmpty(hxTarget))
    {
        <button
            class="px-4 py-2 text-sm font-medium rounded-md @(canGoNext ? "bg-blue-600 text-white hover:bg-blue-700" : "bg-gray-200 text-gray-400 cursor-not-allowed")"
            hx-get="@nextUrl"
            hx-target="@hxTarget"
            hx-swap="@swapValue"
            aria-label="@Model.NextPageAriaLabel"
            disabled="@(!canGoNext)">
            @Model.NextPageText
        </button>
    }
    else if (jsMode == JavaScriptMode.HTMXWithAlpine && !string.IsNullOrEmpty(hxTarget))
    {
        <button
            class="px-4 py-2 text-sm font-medium rounded-md @(canGoNext ? "bg-blue-600 text-white hover:bg-blue-700" : "bg-gray-200 text-gray-400 cursor-not-allowed")"
            x-data
            hx-get="@nextUrl"
            hx-target="@hxTarget"
            hx-swap="@swapValue"
            aria-label="@Model.NextPageAriaLabel"
            disabled="@(!canGoNext)">
            @Model.NextPageText
        </button>
    }
    else if (jsMode == JavaScriptMode.Alpine)
    {
        <button
            class="px-4 py-2 text-sm font-medium rounded-md @(canGoNext ? "bg-blue-600 text-white hover:bg-blue-700" : "bg-gray-200 text-gray-400 cursor-not-allowed")"
            x-data
            @@click="window.location.href = '@nextUrl'"
            aria-label="@Model.NextPageAriaLabel"
            disabled="@(!canGoNext)">
            @Model.NextPageText
        </button>
    }
    else if (jsMode == JavaScriptMode.PlainJS)
    {
        <button
            class="px-4 py-2 text-sm font-medium rounded-md @(canGoNext ? "bg-blue-600 text-white hover:bg-blue-700" : "bg-gray-200 text-gray-400 cursor-not-allowed")"
            onclick="window.location.href = '@nextUrl'"
            aria-label="@Model.NextPageAriaLabel"
            disabled="@(!canGoNext)">
            @Model.NextPageText
        </button>
    }
    else
    {
        @if (canGoNext)
        {
            <a href="@nextUrl"
               class="px-4 py-2 text-sm font-medium rounded-md bg-blue-600 text-white hover:bg-blue-700"
               aria-label="@Model.NextPageAriaLabel">
                @Model.NextPageText
            </a>
        }
        else
        {
            <span class="px-4 py-2 text-sm font-medium rounded-md bg-gray-200 text-gray-400 cursor-not-allowed">@Model.NextPageText</span>
        }
    }

    @* Page Size Selector (optional) *@
    @if (Model.ShowPageSize)
    {
        <div class="ml-4">
            <page-size
                page-size="@pageSize"
                total-items="@(pageSize * 10)"
                link-url="@linkUrl"
                view-type="@Model.ViewType"
                js-mode="@jsMode" />
        </div>
    }
</div>
