@model mostlylucid.pagingtaghelper.Models.TagModels.ContinuationPagerViewModel
@using mostlylucid.pagingtaghelper.Models
@{
    var jsMode = Model.EffectiveJSMode;
    var linkUrl = Model.LinkUrl;
    var currentPage = Model.CurrentPage;
    var pageSize = Model.PageSize;
    var searchTerm = Model.SearchTerm;
    var nextToken = Model.NextPageToken;
    var canGoBack = Model.CanNavigatePrevious;
    var canGoNext = Model.CanNavigateNext;
    var previousToken = Model.GetPreviousPageToken();

    // Serialize token history for passing to next page
    var tokenHistoryJson = Model.PageTokenHistory != null
        ? System.Text.Json.JsonSerializer.Serialize(Model.PageTokenHistory)
        : "{}";

    // Build query strings - preserves all current query parameters except our own (when enabled)
    string BuildQueryString(string? token, int page)
    {
        var query = new Dictionary<string, string>();

        // Define continuation pager's own parameters that should be excluded from preservation
        var pagerParams = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "pageSize", "currentPage", "pageToken", "tokenHistory"
        };

        // Add parameter prefix variants if using prefixed parameters
        if (!string.IsNullOrEmpty(Model.ParameterPrefix))
        {
            pagerParams.Add($"{Model.ParameterPrefix}_pageSize");
            pagerParams.Add($"{Model.ParameterPrefix}_currentPage");
            pagerParams.Add($"{Model.ParameterPrefix}_pageToken");
            pagerParams.Add($"{Model.ParameterPrefix}_tokenHistory");
        }

        // Preserve all existing query parameters (except pager's own) if enabled
        if (Model.PreserveQueryParameters)
        {
            foreach (var param in ViewContext.HttpContext.Request.Query)
            {
                if (!pagerParams.Contains(param.Key))
                {
                    query[param.Key] = param.Value.ToString();
                }
            }
        }

        // Add continuation pager parameters (with prefix if specified)
        var pageSizeParam = Model.GetParameterName("pageSize");
        var currentPageParam = Model.GetParameterName("currentPage");
        var pageTokenParam = Model.GetParameterName("pageToken");
        var tokenHistoryParam = Model.GetParameterName("tokenHistory");

        query[pageSizeParam] = pageSize.ToString();
        query[currentPageParam] = page.ToString();

        if (!string.IsNullOrEmpty(token))
            query[pageTokenParam] = token;

        if (Model.EnableTokenAccumulation)
            query[tokenHistoryParam] = tokenHistoryJson;

        return string.Join("&", query.Select(kvp => $"{Uri.EscapeDataString(kvp.Key)}={Uri.EscapeDataString(kvp.Value)}"));
    }

    var prevUrl = canGoBack ? $"{linkUrl}?{BuildQueryString(previousToken, currentPage - 1)}" : "#";
    var nextUrl = canGoNext ? $"{linkUrl}?{BuildQueryString(nextToken, currentPage + 1)}" : "#";

    // HTMX attributes
    var hxGet = !string.IsNullOrEmpty(Model.HtmxTarget) ? "hx-get" : null;
    var hxTarget = !string.IsNullOrEmpty(Model.HtmxTarget) ? Model.HtmxTarget : null;
    var hxSwap = !string.IsNullOrEmpty(Model.HtmxTarget) ? "hx-swap" : null;
    var swapValue = "outerHTML";
}

<div class="pager-container @Model.CssClass" id="@Model.PagerId">
    @* Previous Button *@
    @if (jsMode == JavaScriptMode.HTMX && !string.IsNullOrEmpty(hxTarget))
    {
        <button
            class="btn btn-sm @(canGoBack ? "" : "btn-disabled")"
            hx-get="@prevUrl"
            hx-target="@hxTarget"
            hx-swap="@swapValue"
            aria-label="@Model.PreviousPageAriaLabel"
            disabled="@(!canGoBack)">
            @Model.PreviousPageText
        </button>
    }
    else if (jsMode == JavaScriptMode.HTMXWithAlpine && !string.IsNullOrEmpty(hxTarget))
    {
        <button
            class="btn btn-sm @(canGoBack ? "" : "btn-disabled")"
            x-data
            hx-get="@prevUrl"
            hx-target="@hxTarget"
            hx-swap="@swapValue"
            aria-label="@Model.PreviousPageAriaLabel"
            disabled="@(!canGoBack)">
            @Model.PreviousPageText
        </button>
    }
    else if (jsMode == JavaScriptMode.Alpine)
    {
        <button
            class="btn btn-sm @(canGoBack ? "" : "btn-disabled")"
            x-data
            @@click="window.location.href = '@prevUrl'"
            aria-label="@Model.PreviousPageAriaLabel"
            disabled="@(!canGoBack)">
            @Model.PreviousPageText
        </button>
    }
    else if (jsMode == JavaScriptMode.PlainJS)
    {
        <button
            class="btn btn-sm @(canGoBack ? "" : "btn-disabled")"
            onclick="window.location.href = '@prevUrl'"
            aria-label="@Model.PreviousPageAriaLabel"
            disabled="@(!canGoBack)">
            @Model.PreviousPageText
        </button>
    }
    else
    {
        @if (canGoBack)
        {
            <a href="@prevUrl"
               class="btn btn-sm"
               aria-label="@Model.PreviousPageAriaLabel">
                @Model.PreviousPageText
            </a>
        }
        else
        {
            <span class="btn btn-sm btn-disabled">@Model.PreviousPageText</span>
        }
    }

    @* Page Numbers (for visited pages) *@
    @if (Model.ShowPageNumber && Model.PageTokenHistory != null && Model.PageTokenHistory.Any())
    {
        var maxVisiblePage = Math.Max(currentPage, Model.PageTokenHistory.Keys.Max());

        <div class="join">
            @for (int pageNum = 1; pageNum <= maxVisiblePage; pageNum++)
            {
                var isCurrentPage = pageNum == currentPage;
                var canNavigateToPage = pageNum < currentPage && Model.PageTokenHistory.ContainsKey(pageNum);

                string pageUrl;
                if (pageNum == 1)
                {
                    // Page 1 has no token (it's the start)
                    pageUrl = $"{linkUrl}?{BuildQueryString(null, 1)}";
                }
                else if (canNavigateToPage)
                {
                    var token = Model.PageTokenHistory[pageNum];
                    pageUrl = $"{linkUrl}?{BuildQueryString(token, pageNum)}";
                }
                else
                {
                    pageUrl = "#";
                }

                if (isCurrentPage)
                {
                    <span class="join-item btn btn-sm btn-active">@pageNum</span>
                }
                else if (pageNum < currentPage)
                {
                    if (jsMode == JavaScriptMode.HTMX && !string.IsNullOrEmpty(hxTarget))
                    {
                        <button
                            class="join-item btn btn-sm"
                            hx-get="@pageUrl"
                            hx-target="@hxTarget"
                            hx-swap="@swapValue"
                            aria-label="Go to page @pageNum">
                            @pageNum
                        </button>
                    }
                    else if (jsMode == JavaScriptMode.HTMXWithAlpine && !string.IsNullOrEmpty(hxTarget))
                    {
                        <button
                            class="join-item btn btn-sm"
                            x-data
                            hx-get="@pageUrl"
                            hx-target="@hxTarget"
                            hx-swap="@swapValue"
                            aria-label="Go to page @pageNum">
                            @pageNum
                        </button>
                    }
                    else if (jsMode == JavaScriptMode.Alpine)
                    {
                        <button
                            class="join-item btn btn-sm"
                            x-data
                            @@click="window.location.href = '@pageUrl'"
                            aria-label="Go to page @pageNum">
                            @pageNum
                        </button>
                    }
                    else if (jsMode == JavaScriptMode.PlainJS)
                    {
                        <button
                            class="join-item btn btn-sm"
                            onclick="window.location.href = '@pageUrl'"
                            aria-label="Go to page @pageNum">
                            @pageNum
                        </button>
                    }
                    else
                    {
                        <a href="@pageUrl"
                           class="join-item btn btn-sm"
                           aria-label="Go to page @pageNum">
                            @pageNum
                        </a>
                    }
                }
                else
                {
                    @* Future page - show but disabled *@
                    <span class="join-item btn btn-sm btn-disabled">@pageNum</span>
                }
            }
        </div>
    }
    else if (Model.ShowPageNumber)
    {
        @* Simple current page indicator when no history *@
        <div class="badge badge-lg">
            <text>Page </text>@currentPage
        </div>
    }

    @* Next Button *@
    @if (jsMode == JavaScriptMode.HTMX && !string.IsNullOrEmpty(hxTarget))
    {
        <button
            class="btn btn-sm @(canGoNext ? "" : "btn-disabled")"
            hx-get="@nextUrl"
            hx-target="@hxTarget"
            hx-swap="@swapValue"
            aria-label="@Model.NextPageAriaLabel"
            disabled="@(!canGoNext)">
            @Model.NextPageText
        </button>
    }
    else if (jsMode == JavaScriptMode.HTMXWithAlpine && !string.IsNullOrEmpty(hxTarget))
    {
        <button
            class="btn btn-sm @(canGoNext ? "" : "btn-disabled")"
            x-data
            hx-get="@nextUrl"
            hx-target="@hxTarget"
            hx-swap="@swapValue"
            aria-label="@Model.NextPageAriaLabel"
            disabled="@(!canGoNext)">
            @Model.NextPageText
        </button>
    }
    else if (jsMode == JavaScriptMode.Alpine)
    {
        <button
            class="btn btn-sm @(canGoNext ? "" : "btn-disabled")"
            x-data
            @@click="window.location.href = '@nextUrl'"
            aria-label="@Model.NextPageAriaLabel"
            disabled="@(!canGoNext)">
            @Model.NextPageText
        </button>
    }
    else if (jsMode == JavaScriptMode.PlainJS)
    {
        <button
            class="btn btn-sm @(canGoNext ? "" : "btn-disabled")"
            onclick="window.location.href = '@nextUrl'"
            aria-label="@Model.NextPageAriaLabel"
            disabled="@(!canGoNext)">
            @Model.NextPageText
        </button>
    }
    else
    {
        @if (canGoNext)
        {
            <a href="@nextUrl"
               class="btn btn-sm"
               aria-label="@Model.NextPageAriaLabel">
                @Model.NextPageText
            </a>
        }
        else
        {
            <span class="btn btn-sm btn-disabled">@Model.NextPageText</span>
        }
    }

    @* Page Size Selector (optional) *@
    @if (Model.ShowPageSize)
    {
        <div class="ml-4">
            <page-size
                page-size="@pageSize"
                total-items="@(pageSize * 10)"
                link-url="@linkUrl"
                view-type="@Model.ViewType"
                js-mode="@jsMode" />
        </div>
    }
</div>
